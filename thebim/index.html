<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Multi-Translation Bible</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #f4f7ff, #e9efff);
      --glass: rgba(255, 255, 255, 0.6);
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --secondary: #10b981;
      --accent: #f59e0b;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --radius: 12px;
      --shadow-light: 0 4px 30px rgba(0,0,0,0.05);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      display: flex; flex-direction: column;
      font-family: 'Inter', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      height: 100vh; overflow: hidden;
    }
    h1 {
      text-align: center;
      padding: 1rem;
      font-weight: 600;
      font-size: 1.75rem;
      background: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-light);
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) 80px 80px;
      gap: 1rem;
      padding: 1rem;
      background: var(--glass);
      backdrop-filter: blur(15px);
      border-radius: var(--radius);
      box-shadow: var(--shadow-light);
      margin: 0 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .controls select, .controls button {
      background: var(--glass);
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      font-size: 1rem;
      color: var(--text-main);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transition: background 0.2s, transform 0.1s;
    }
    .controls select:focus, .controls button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(79,70,229,0.3);
    }
    .controls button {
      cursor: pointer;
    }
    .controls button:hover:not(:disabled) {
      background: var(--primary-hover);
      color: #fff;
      transform: translateY(-2px);
    }
    .controls button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #compare-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      max-height: 4.5rem;
      overflow-y: auto;
    }
    #compare-container label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: var(--secondary);
      color: #fff;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: transform 0.1s;
    }
    #compare-container label:hover {
      transform: scale(1.05);
      background: #059669;
    }
    #compare-container input { accent-color: #fff; }
    .content-wrapper {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 2fr;
      overflow: hidden;
      gap: 1rem;
      padding: 1rem;
    }
    aside#image-panel {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow-light);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow: hidden;
    }
    #verse-image { max-width: 100%; height: auto; border-radius: var(--radius); }
    .translations {
      overflow-y: auto;
      padding: 1rem;
    }
    .card {
      background: var(--glass);
      backdrop-filter: blur(8px);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius);
      box-shadow: var(--shadow-light);
      margin-bottom: 1rem;
      padding: 1rem;
      position: relative;
    }
    .card h2 {
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .card p {
      line-height: 1.6;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .card .prog {
      text-align: right;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .icons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 0.5rem;
    }
    .icons button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: color 0.2s, transform 0.1s;
    }
    .icons button:hover {
      color: var(--accent);
      transform: scale(1.1);
    }
    #verse-slider {
      width: calc(100% - 2rem);
      margin: 1rem;
    }
    @media (max-width: 800px) {
      .content-wrapper { grid-template-columns: 1fr; }
      aside#image-panel { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>Bible Interactive Model</h1>
  <div class="controls">
    <select id="primary" disabled></select>
    <div id="compare-container"></div>
    <select id="book" disabled></select>
    <select id="chap" disabled></select>
    <select id="verse" disabled></select>
    <button id="prev" disabled>â—€</button>
    <button id="next" disabled>â–¶</button>
    <button id="global-search-btn" title="Search">ðŸ”Ž</button>
  </div>
  <div id="search-modal" class="hidden">
    <div class="search-overlay"></div>
    <div class="search-panel">
      <button id="search-close">âœ–</button>
      <input id="search-input-global" placeholder="Search all versesâ€¦">
      <div class="search-filters">
        <select id="filter-translation"><option value="">All Bibles</option></select>
        <select id="filter-testament">
          <option value="">Both</option>
          <option value="ot">Old Testament</option>
          <option value="nt">New Testament</option>
        </select>
        <select id="filter-book"><option value="">All Books</option></select>
        <select id="filter-chapter"><option value="">All Chapters</option></select>
      </div>
      <div class="search-stats" id="search-stats"></div>
      <ul id="search-results"></ul>
    </div>
  </div>
  <div class="content-wrapper">
    <aside id="image-panel">
      <img id="verse-image" src="" alt="Verse">
    </aside>
    <div class="translations" id="output">
      <p style="color:var(--muted);padding:1rem;">Loading translationsâ€¦</p>
    </div>
  </div>
  <input type="range" id="verse-slider" disabled>

  <script>
  (async function(){
    // Helpers & state
    const apiUrl = 'https://api.github.com/repos/mdudumi/thebim/contents/thebim/Translations';
    let transData={}, lists={}, state={idx:0,bkIdx:0,chIdx:0};

    function fillSelect(sel, items){
      sel.innerHTML = '';
      items.forEach(i=> sel.append(new Option(i.label,i.value)));
      sel.disabled = !items.length;
    }
    function nest(json){
      const o={};
      (json.verses||[]).forEach(v=>{
        o[v.book_name]=o[v.book_name]||{};
        o[v.book_name][v.chapter]=o[v.book_name][v.chapter]||[];
        o[v.book_name][v.chapter].push(v.text);
      });
      return o;
    }

    // 1) fetch folder contents
    const files = await fetch(apiUrl)
      .then(r=>r.json())
      .catch(e=>{console.error(e);return[];});

    // 2) load each JSON
    for(let f of files){
      if(!f.name.endsWith('.json')) continue;
      const name = f.name.replace(/\.json$/i,'');
      try{
        const data = await fetch(f.download_url).then(r=>r.json());
        const nested = nest(data);
        transData[name]=nested;
        const books=Object.keys(nested), chs={};
        books.forEach(b=> chs[b]=Object.keys(nested[b]));
        lists[name]={books,chapters:chs};
      }catch(e){
        console.warn('fail',f.name,e);
      }
    }

    // 3) grab DOM
    const primary         = document.getElementById('primary'),
          compareC        = document.getElementById('compare-container'),
          bookSel         = document.getElementById('book'),
          chapSel         = document.getElementById('chap'),
          verseSel        = document.getElementById('verse'),
          prevBtn         = document.getElementById('prev'),
          nextBtn         = document.getElementById('next'),
          output          = document.getElementById('output'),
          verseImg        = document.getElementById('verse-image'),
          globalSearchBtn = document.getElementById('global-search-btn'),
          searchModal     = document.getElementById('search-modal'),
          searchClose     = document.getElementById('search-close'),
          globalInput     = document.getElementById('search-input-global'),
          resultsList     = document.getElementById('search-results'),
          statsDiv        = document.getElementById('search-stats'),
          filtTrans       = document.getElementById('filter-translation'),
          filtTestament   = document.getElementById('filter-testament'),
          filtBook        = document.getElementById('filter-book'),
          filtChapter     = document.getElementById('filter-chapter'),
          verseSlider     = document.getElementById('verse-slider');

    // 4) populate primary & compare & search filters
    fillSelect(primary, Object.keys(transData).map(n=>({label:n,value:n})));
    Object.keys(transData).forEach(n=>{
      const lbl=document.createElement('label');
      lbl.innerHTML=<input type="checkbox" value="${n}"> ${n};
      compareC.append(lbl);
    });
    fillSelect(filtTrans, Object.keys(transData).map(n=>({label:n,value:n})));

    // 5) define handlers
    primary.onchange=()=>{
      state={idx:0,bkIdx:0,chIdx:0};
      const books=lists[primary.value].books;
      fillSelect(bookSel,books.map((b,i)=>({label:b,value:i})));
      fillSelect(chapSel,[]); fillSelect(verseSel,[]);
      prevBtn.disabled=nextBtn.disabled=true;
      output.innerHTML=<p style="color:var(--muted);padding:1rem;">Select a book.</p>;
      verseImg.src=''; verseSlider.disabled=true;
      updateURL();
    };
    bookSel.onchange=()=>{
      state.bkIdx=+bookSel.value;
      const bk=lists[primary.value].books[state.bkIdx];
      const chs=lists[primary.value].chapters[bk];
      fillSelect(chapSel,chs.map((c,i)=>({label:c,value:i})));
      fillSelect(verseSel,[]);
      prevBtn.disabled=nextBtn.disabled=true;
      output.innerHTML=<p style="color:var(--muted);padding:1rem;">Select a chapter.</p>;
      verseImg.src=''; verseSlider.disabled=true;
      updateURL();
    };
    chapSel.onchange=()=>{
      state.chIdx=+chapSel.value; state.idx=0;
      const bk=lists[primary.value].books[state.bkIdx];
      const ch=lists[primary.value].chapters[bk][state.chIdx];
      const verses=transData[primary.value][bk][ch]||[];
      fillSelect(verseSel,verses.map((_,i)=>({label:i+1,value:i})));
      prevBtn.disabled=nextBtn.disabled=false;
      verseSlider.disabled=false;
      verseSlider.max=verses.length-1;
      verseSlider.value=0;
      output.innerHTML='';
      renderAll(); updateURL();
    };
    verseSel.onchange=()=>{
      state.idx=+verseSel.value;
      verseSlider.value=state.idx;
      renderAll(); updateURL();
    };
    prevBtn.onclick=()=>navigate(-1);
    nextBtn.onclick=()=>navigate(1);
    verseSlider.oninput=()=>{
      state.idx=+verseSlider.value;
      verseSel.value=state.idx;
      renderAll(); updateURL();
    };
    compareC.addEventListener('change',()=>{ if(!verseSel.disabled) renderAll(); });

    filtTrans.onchange=()=>{
      const t=filtTrans.value||primary.value;
      const bs=lists[t]?.books||[];
      fillSelect(filtBook,[{label:'All Books',value:''},...bs.map((b,i)=>({label:b,value:i}))]);
      filtBook.onchange();
    };
    filtBook.onchange=()=>{
      const t=filtTrans.value||primary.value;
      const bi=filtBook.value;
      const bk=bi===''?null:lists[t].books[+bi];
      const cs=bk?lists[t].chapters[bk]:[];
      fillSelect(filtChapter,[{label:'All Chapters',value:''},...cs.map((c,i)=>({label:c,value:i}))]);
    };

    globalSearchBtn.onclick=()=>{
      searchModal.classList.remove('hidden');
      globalInput.value=''; resultsList.innerHTML=''; statsDiv.textContent='';
      filtTrans.focus();
    };
    searchClose.onclick=()=>searchModal.classList.add('hidden');
    globalInput.addEventListener('keydown',e=>{
      if(e.key!=='Enter') return;
      const term=e.target.value.trim().toLowerCase();
      if(!term) return;
      resultsList.innerHTML='<li>Searchingâ€¦</li>'; statsDiv.textContent='';
      const tf=filtTrans.value, tfm=filtTestament.value, bf=filtBook.value, cf=filtChapter.value;
      let matches=[];
      Object.entries(transData).forEach(([tn,bs])=>{
        if(tf && tn!==tf) return;
        lists[tn].books.forEach((bni,bii)=>{
          if(bf!=='' && bii.toString()!==bf) return;
          const isOT=bii<39;
          if(tfm==='ot'&&!isOT) return;
          if(tfm==='nt'&&isOT) return;
          const chs=bs[bni]||{};
          Object.entries(chs).forEach(([chn,vs],chi)=>{
            if(cf!==''&&chi.toString()!==cf) return;
            vs.forEach((txt,vi)=>{
              if(txt.toLowerCase().includes(term)){
                const s=txt.toLowerCase().indexOf(term);
                const sn='â€¦'+txt.substr(Math.max(0,s-20),term.length+40)+'â€¦';
                matches.push({tn,bii,chi,vi,sn});
              }
            });
          });
        });
      });
      statsDiv.textContent=Found ${matches.length} occurrence${matches.length!==1?'s':''};
      resultsList.innerHTML='';
      matches.forEach(m=>{
        const bn=lists[m.tn].books[m.bii];
        const cn=lists[m.tn].chapters[bn][m.chi];
        const li=document.createElement('li');
        li.innerHTML=<strong>[${m.tn}] ${bn} ${cn}:${m.vi+1}</strong><p><em>${m.sn}</em></p>;
        li.onclick=()=>{
          primary.value=m.tn; primary.onchange();
          bookSel.value=m.bii; bookSel.onchange();
          chapSel.value=m.chi; chapSel.onchange();
          verseSel.value=m.vi; verseSel.onchange();
          searchModal.classList.add('hidden');
        };
        resultsList.append(li);
      });
    });

    function updateURL(){
      const p=new URLSearchParams();
      p.set('primary',primary.value);
      p.set('book',state.bkIdx);
      p.set('chap',state.chIdx);
      p.set('verse',state.idx);
      history.replaceState(null,'','?'+p.toString());
      document.title=${lists[primary.value].books[state.bkIdx]} ${state.chIdx+1}:${state.idx+1};
    }
    function renderAll(){
      output.innerHTML='';
      const {idx,bkIdx,chIdx}=state;
      const main=primary.value;
      const bk=lists[main].books[bkIdx];
      const ch=lists[main].chapters[bk][chIdx];
      const vs=transData[main][bk][ch]||[];
      const total=vs.length;
      verseImg.src=images/${bkIdx+1}/${chIdx+1}/${idx+1}.jpg;
      const checked=Array.from(compareC.querySelectorAll('input:checked')).map(i=>i.value).filter(n=>n!==main);
      const names=[main,...checked];
      names.forEach(name=>{
        const b2=lists[name].books[bkIdx];
        const c2s=lists[name].chapters[b2]||[];
        const txt=transData[name][b2]?.[c2s[chIdx]]?.[idx]||'';
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=<h2>${name}</h2><p>${txt}</p><div class="prog">${idx+1} / ${total}</div>;
        const icons=document.createElement('div'); icons.className='icons';
        const noteBtn=document.createElement('button');
        noteBtn.innerText='ðŸ“'; noteBtn.title='Note';
        noteBtn.onclick=()=>{
          const vid=${name}|${bkIdx}|${chIdx}|${idx};
          const notes=JSON.parse(localStorage.getItem('notes')||'{}');
          const n=prompt('Note:',notes[vid]||'');
          notes[vid]=n; localStorage.setItem('notes',JSON.stringify(notes));
        };
        const copyBtn=document.createElement('button');
        copyBtn.innerText='ðŸ“‹'; copyBtn.title='Copy';
        copyBtn.onclick=()=>navigator.clipboard.writeText(txt).then(()=>alert('Copied!'));
        const shareBtn=document.createElement('button');
        shareBtn.innerText='ðŸ”—'; shareBtn.title='Share';
        shareBtn.onclick=()=>{
          const url=${location.origin}${location.pathname}?primary=${name}&book=${bkIdx}&chap=${chIdx}&verse=${idx};
          if(navigator.share) navigator.share({title:${bk} ${chIdx+1}:${idx+1},url});
          else navigator.clipboard.writeText(url).then(()=>alert('Link copied!'));
        };
        icons.append(noteBtn,copyBtn,shareBtn);
        card.append(icons);
        output.append(card);
      });
      prevBtn.disabled=state.idx===0;
      nextBtn.disabled=state.idx>=total-1;
    }
    function navigate(d){
      const m=+verseSlider.max;
      state.idx=Math.max(0,Math.min(m,state.idx+d));
      verseSel.value=state.idx; verseSlider.value=state.idx;
      renderAll(); updateURL();
    }
    function handleDeepLink(){
      const p=new URLSearchParams(location.search);
      if(p.has('primary')&&lists[p.get('primary')]){
        primary.value=p.get('primary'); primary.onchange();
      }
      if(p.has('book')){
        bookSel.value=p.get('book'); bookSel.onchange();
      }
      if(p.has('chap')){
        chapSel.value=p.get('chap'); chapSel.onchange();
      }
      if(p.has('verse')){
        verseSel.value=p.get('verse'); verseSel.onchange();
      }
    }

    // 6) auto-select first translation
    primary.disabled=false;
    if(primary.options.length){
primary.selectedIndex = 0;
primary.dispatchEvent(new Event('change'));
    }
    handleDeepLink();
  })();
  </script>
</body>
</html>

