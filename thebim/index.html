<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Multi-Translation Bible</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg-light: #f9fafb;
      --bg-dark: #1f2937;
      --panel-light: #ffffff;
      --panel-dark: #374151;
      --border-light: #e5e7eb;
      --border-dark: #4b5563;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #10b981;
      --accent: #f59e0b;
      --text-light: #111827;
      --text-dark: #f3f4f6;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --radius: 0.5rem;
      --shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.2s ease-in-out;
    }
    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --border: var(--border-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
    }
    [data-theme="light"] {
      --bg: var(--bg-light);
      --panel: var(--panel-light);
      --border: var(--border-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
    }
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Inter", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
      transition: var(--transition);
    }
    header {
      padding: 1rem 2rem;
      background: var(--panel);
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--muted);
      transition: var(--transition);
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) 48px 48px 48px;
      gap: 0.75rem;
      padding: 1rem 2rem;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }
    .controls select,
    .controls button.search-btn,
    .controls button.nav-btn {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--panel);
      transition: var(--transition);
    }
    .controls select:focus,
    .controls button:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    .controls button.nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .controls button.search-btn {
      cursor: pointer;
    }
    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .compare-list {
      display: flex;
      overflow-x: auto;
      gap: 0.5rem;
      padding: 0.5rem 0;
    }
    .compare-list label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: var(--secondary);
      color: #fff;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
    }
    .compare-list input {
      accent-color: #fff;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 2fr;
      overflow: hidden;
    }
    .verse-image-wrapper {
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow: hidden;
    }
    #verse-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .translations {
      padding: 1rem 2rem;
      overflow-y: auto;
      background: var(--bg);
    }
    .card {
      background: var(--panel);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
    }
    .card:hover {
      transform: translateY(-2px);
    }
    .card h2 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    .card p {
      flex: 1;
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }
    .progress {
      text-align: right;
      font-size: 0.875rem;
      color: var(--muted);
    }
    .icons {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }
    .icons button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      color: var(--muted);
      transition: var(--transition);
    }
    .icons button:hover {
      color: var(--accent);
    }
    /* Search Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }
    .modal.open {
      opacity: 1;
      visibility: visible;
    }
    .modal .panel {
      background: var(--panel);
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      max-height: 80vh;
      overflow: auto;
    }
    .modal header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .modal header h2 {
      font-size: 1.25rem;
      color: var(--primary);
    }
    .modal header button {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--muted);
    }
    .search-input {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 1rem;
    }
    .search-filters {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .search-filters select {
      padding: 0.5rem;
      font-size: 0.95rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--panel);
    }
    .search-stats {
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    #searchResults {
      list-style: none;
      max-height: 50vh;
      overflow-y: auto;
      padding: 0;
    }
    #searchResults li {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    #searchResults li:hover {
      background: var(--bg);
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      .verse-image-wrapper {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Interactive Bible</h1>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">üåô</button>
  </header>

  <div class="controls">
    <select id="primary"></select>
    <div class="compare-list" id="compareContainer"></div>
    <select id="book"></select>
    <select id="chap"></select>
    <select id="verse"></select>
    <button class="nav-btn" id="prev" aria-label="Previous">‚óÄ</button>
    <button class="nav-btn" id="next" aria-label="Next">‚ñ∂</button>
    <button class="search-btn" id="globalSearchBtn" aria-label="Search">üîé</button>
  </div>

  <main>
    <aside class="verse-image-wrapper">
      <img id="verse-image" src="" alt="Verse illustration" />
    </aside>
    <section class="translations" id="output">
      <p style="color: var(--muted);">Loading translations‚Ä¶</p>
    </section>
  </main>

  <div class="modal" id="searchModal">
    <div class="panel">
      <header>
        <h2>Search All Verses</h2>
        <button id="searchClose" aria-label="Close">‚úñ</button>
      </header>
      <input id="searchInputGlobal" class="search-input" placeholder="Search all verses‚Ä¶" />
      <div class="search-filters">
        <select id="filterTranslation"><option value="">All Bibles</option></select>
        <select id="filterTestament">
          <option value="">Both</option>
          <option value="ot">Old Testament</option>
          <option value="nt">New Testament</option>
        </select>
        <select id="filterBook"><option value="">All Books</option></select>
        <select id="filterChapter"><option value="">All Chapters</option></select>
      </div>
      <div class="search-stats" id="searchStats"></div>
      <ul id="searchResults"></ul>
    </div>
  </div>

  <script>
  (function(){
    // Theme toggle
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.addEventListener("click", ()=>{
      const html = document.documentElement;
      const next = html.getAttribute("data-theme")==="light" ? "dark" : "light";
      html.setAttribute("data-theme", next);
      themeToggle.textContent = next==="light" ? "üåô" : "‚òÄÔ∏è";
    });

    // API & state
    const apiUrl = 'https://api.github.com/repos/mdudumi/thebim/contents/thebim/Translations';
    let transData = {}, lists = {}, state = {idx:0,bkIdx:0,chIdx:0};

    // Helpers
    function fillSelect(sel, items){
      sel.innerHTML = '';
      items.forEach(i=> sel.append(new Option(i.label, i.value)));
      sel.disabled = !items.length;
    }
    function nest(json){
      const o = {};
      (json.verses||[]).forEach(v=>{
        o[v.book_name] = o[v.book_name]||{};
        o[v.book_name][v.chapter] = o[v.book_name][v.chapter]||[];
        o[v.book_name][v.chapter].push(v.text);
      });
      return o;
    }

    // Fetch translation files
    fetch(apiUrl).then(r=>r.json()).then(files=>{
      files.filter(f=>f.name.endsWith('.json')).forEach(f=>{
        const name = f.name.replace(/\.json$/i,'');
        fetch(f.download_url).then(r=>r.json()).then(data=>{
          const nested = nest(data);
          transData[name] = nested;
          const books = Object.keys(nested);
          const chs = {};
          books.forEach(b=> chs[b] = Object.keys(nested[b]));
          lists[name] = { books, chapters: chs };
        });
      });
    }).finally(initUI);

    // Initialize UI once data loaded
    function initUI(){
      // Elements
      const primary       = document.getElementById('primary');
      const compareC      = document.getElementById('compareContainer');
      const bookSel       = document.getElementById('book');
      const chapSel       = document.getElementById('chap');
      const verseSel      = document.getElementById('verse');
      const prevBtn       = document.getElementById('prev');
      const nextBtn       = document.getElementById('next');
      const output        = document.getElementById('output');
      const verseImg      = document.getElementById('verse-image');
      const searchBtn     = document.getElementById('globalSearchBtn');
      const modal         = document.getElementById('searchModal');
      const searchClose   = document.getElementById('searchClose');
      const searchInput   = document.getElementById('searchInputGlobal');
      const resultsList   = document.getElementById('searchResults');
      const statsDiv      = document.getElementById('searchStats');
      const filtTrans     = document.getElementById('filterTranslation');
      const filtTest      = document.getElementById('filterTestament');
      const filtBook      = document.getElementById('filterBook');
      const filtChap      = document.getElementById('filterChapter');

      // Populate primary & compare & filter translation
      fillSelect(primary, Object.keys(transData).map(n=>({label:n,value:n})));
      Object.keys(transData).forEach(n=>{
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${n}"> ${n}`;
        compareC.append(lbl);
      });
      fillSelect(filtTrans, Object.keys(transData).map(n=>({label:n,value:n})));

      // Handlers
      primary.onchange = ()=> {
        state = {idx:0,bkIdx:0,chIdx:0};
        const books = lists[primary.value].books;
        fillSelect(bookSel, books.map((b,i)=>({label:b,value:i})));
        fillSelect(chapSel, []);
        fillSelect(verseSel, []);
        prevBtn.disabled = nextBtn.disabled = true;
        output.innerHTML = `<p style="color:var(--muted);">Select a book.</p>`;
        verseImg.src = '';
      };
      bookSel.onchange = ()=> {
        state.bkIdx = +bookSel.value;
        const bk = lists[primary.value].books[state.bkIdx];
        const chs = lists[primary.value].chapters[bk];
        fillSelect(chapSel, chs.map((c,i)=>({label:c,value:i})));
        fillSelect(verseSel, []);
        prevBtn.disabled = nextBtn.disabled = true;
        output.innerHTML = `<p style="color:var(--muted);">Select a chapter.</p>`;
        verseImg.src = '';
      };
      chapSel.onchange = ()=> {
        state.chIdx = +chapSel.value;
        state.idx = 0;
        const bk = lists[primary.value].books[state.bkIdx];
        const ch = lists[primary.value].chapters[bk][state.chIdx];
        const verses = transData[primary.value][bk][ch]||[];
        fillSelect(verseSel, verses.map((_,i)=>({label:i+1,value:i})));
        prevBtn.disabled = nextBtn.disabled = false;
        verseSel.value = 0;
        renderAll();
      };
      verseSel.onchange = ()=> {
        state.idx = +verseSel.value;
        renderAll();
      };
      prevBtn.onclick = ()=> navigate(-1);
      nextBtn.onclick = ()=> navigate(1);

      function renderAll(){
        output.innerHTML = '';
        const {idx,bkIdx,chIdx} = state;
        const main = primary.value;
        const bk = lists[main].books[bkIdx];
        const ch = lists[main].chapters[bk][chIdx];
        const vs = transData[main][bk][ch]||[];
        verseImg.src = `images/${bkIdx+1}/${chIdx+1}/${idx+1}.jpg`;
        const checked = Array.from(compareC.querySelectorAll('input:checked'))
                             .map(i=>i.value)
                             .filter(n=>n!==main);
        const names = [main, ...checked];
        names.forEach(name=>{
          const b2 = lists[name].books[bkIdx];
          const c2s = lists[name].chapters[b2]||[];
          const txt = transData[name][b2]?.[c2s[chIdx]]?.[idx]||'';
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h2>${name}</h2>
            <p>${txt}</p>
            <div class="progress">${idx+1} / ${vs.length}</div>
            <div class="icons">
              <button title="Note">üìù</button>
              <button title="Copy">üìã</button>
              <button title="Share">üîó</button>
            </div>`;
          output.append(card);
        });
        prevBtn.disabled = state.idx===0;
        nextBtn.disabled = state.idx >= vs.length-1;
        verseSel.value = state.idx;
      }
      function navigate(dir){
        const bk = lists[primary.value].books[state.bkIdx];
        const ch = lists[primary.value].chapters[bk][state.chIdx];
        const max = (transData[primary.value][bk][ch]||[]).length - 1;
        state.idx = Math.min(max, Math.max(0, state.idx + dir));
        renderAll();
      }

      // Search modal logic
      searchBtn.onclick = ()=> modal.classList.add('open');
      searchClose.onclick = ()=> modal.classList.remove('open');
      searchInput.addEventListener('keydown', e=>{
        if(e.key !== 'Enter') return;
        const term = e.target.value.trim().toLowerCase();
        if(!term) return;
        resultsList.innerHTML = '<li>Searching‚Ä¶</li>';
        statsDiv.textContent = '';
        const tf = filtTrans.value, tfm = filtTest.value, bf = filtBook.value, cf = filtChap.value;
        const matches = [];
        Object.entries(transData).forEach(([tn, bs])=>{
          if(tf && tn !== tf) return;
          lists[tn].books.forEach((bni, bii)=>{
            if(bf !== '' && bii.toString() !== bf) return;
            const isOT = bii < 39;
            if(tfm==='ot'&&!isOT) return;
            if(tfm==='nt'&& isOT) return;
            const chs = bs[bni]||{};
            Object.entries(chs).forEach(([chn, vs], chi)=>{
              if(cf !== '' && chi.toString() !== cf) return;
              vs.forEach((txt, vi)=>{
                if(txt.toLowerCase().includes(term)){
                  const start = txt.toLowerCase().indexOf(term);
                  const snippet = '‚Ä¶'+txt.substr(Math.max(0, start-20), term.length+40)+'‚Ä¶';
                  matches.push({tn, bii, chi, vi, snippet});
                }
              });
            });
          });
        });
        statsDiv.textContent = `Found ${matches.length} occurrence${matches.length!==1?'s':''}`;
        resultsList.innerHTML = '';
        matches.forEach(m=>{
          const bn = lists[m.tn].books[m.bii];
          const cn = lists[m.tn].chapters[bn][m.chi];
          const li = document.createElement('li');
          li.innerHTML = `<strong>[${m.tn}] ${bn} ${cn}:${m.vi+1}</strong><p><em>${m.snippet}</em></p>`;
          li.onclick = ()=>{
            primary.value = m.tn; primary.onchange();
            bookSel.value = m.bii; bookSel.onchange();
            chapSel.value = m.chi; chapSel.onchange();
            verseSel.value = m.vi; verseSel.onchange();
            modal.classList.remove('open');
          };
          resultsList.append(li);
        });
      };

      // Deep link handling
      const params = new URLSearchParams(location.search);
      if(params.has('primary')) primary.value = params.get('primary'), primary.onchange();
      if(params.has('book')) bookSel.value = params.get('book'), bookSel.onchange();
      if(params.has('chap')) chapSel.value = params.get('chap'), chapSel.onchange();
      if(params.has('verse')) verseSel.value = params.get('verse'), verseSel.onchange();
    }
  })();
  </script>
</body>
</html>
