<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Interactive Bible ‚Ä¢ Modern Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --accent: #14b8a6;
      --neutral: #64748b;
      --text: #1e293b;
      --radius: 12px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --transition: 0.3s ease;
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex; flex-direction:column;
      min-height:100vh;
    }
    header {
      background:var(--surface);
      padding:1rem;
      box-shadow:var(--shadow-sm);
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:10;
    }
    header h1 { font-size:1.25rem; font-weight:600; }
    header button {
      background:none; border:none; font-size:1.25rem; cursor:pointer;
    }
    .controls {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(128px,1fr));
      gap:.75rem;
      padding:1rem;
      background:var(--surface);
      box-shadow:var(--shadow-sm);
    }
    .controls select, .controls button {
      width:100%; padding:.75rem 1rem;
      border-radius:var(--radius);
      border:1px solid #e2e8f0;
      font-size:.95rem;
      transition:border-color var(--transition),box-shadow var(--transition);
      background:var(--surface);
    }
    .controls select:focus, .controls button:focus {
      outline:none;
      border-color:var(--primary-light);
      box-shadow:0 0 0 3px rgba(99,102,241,0.35);
    }
    .controls button {
      background:var(--primary);
      color:#fff;
      font-weight:500;
      border:none;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
    }
    .controls button:disabled {
      background:#e2e8f0; cursor:not-allowed; color:var(--neutral);
    }
    .controls .range-wrapper {
      grid-column: span 6;
      padding:0 1rem;
    }
    #verse-slider { width:100%; accent-color:var(--accent); }
    #compare-container {
      grid-column: span 6;
      display:flex; flex-wrap:wrap; gap:.5rem;
      padding:.5rem;
      border:1px solid #e2e8f0;
      border-radius:var(--radius);
      background:#fafbfc;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1rem;
      overflow: hidden;
      padding: 1rem;
    }
    @media (max-width:900px) { main { display:flex; flex-direction:column; } }
    aside#image-panel {
      background: var(--surface);
      padding: 0;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      overflow: hidden;
    }
    #verse-image {
      width:100%; height:100%; object-fit: cover; border-radius:var(--radius);
    }
    .translations {
      overflow-y:auto; padding:1rem;
    }
    .card {
      background:var(--surface);
      border-radius:var(--radius);
      box-shadow:var(--shadow-sm);
      margin-bottom:1rem; padding:1rem;
      position:relative;
      transition:transform var(--transition);
    }
    .card:hover {
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }
    .card h2 { font-size:1rem; font-weight:500; color:var(--primary); margin-bottom:.5rem; }
    .card p { font-size:.95rem; line-height:1.5; margin-bottom:.75rem; }
    .card .prog { font-size:.85rem; color:var(--neutral); text-align:right; }
    .icons {
      position:absolute; top:.75rem; right:.75rem;
      display:flex; gap:.5rem;
    }
    .icons button { background:none; border:none; cursor:pointer; font-size:1.1rem; color:var(--neutral); transition:color var(--transition); }
    .icons button:hover { color:var(--accent); }
    #search-modal { display:none; position:fixed; inset:0; z-index:20; }
    #search-modal.active { display:block; }
    .search-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.4); }
    .search-panel {
      position:absolute; top:10%; left:50%; transform:translateX(-50%);
      width:90%; max-width:600px;
      background:var(--surface);
      border-radius:var(--radius);
      padding:1rem;
      box-shadow:var(--shadow-md);
    }
    #search-close { float:right; background:none; border:none; font-size:1.2rem; cursor:pointer; }
    #search-input-global { width:100%; padding:.5rem; font-size:1rem; border:1px solid #e2e8f0; border-radius:4px; margin-bottom:.5rem; }
    #start-search { width:100%; padding:.5rem; font-size:1rem; margin-bottom:1rem; border-radius:4px; border:none; background:var(--primary); color:#fff; cursor:pointer; }
    #start-search:disabled { background:#e2e8f0; cursor:not-allowed; color:var(--neutral); }
    .search-filters { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:.5rem; margin-bottom:.75rem; background:var(--surface); padding:.5rem; border-radius:var(--radius); box-shadow:var(--shadow-sm); }
    .search-filters select { padding:.5rem; font-size:.95rem; border:1px solid #e2e8f0; border-radius:var(--radius); background:var(--surface); }
    .search-stats { margin-bottom:.5rem; font-size:.95rem; color:var(--neutral); }
    #search-results { list-style:none; max-height:50vh; overflow-y:auto; padding:0; }
    #search-results li { padding:.5rem; border-bottom:1px solid #e2e8f0; cursor:pointer; transition:background var(--transition); }
    #search-results li:hover { background:var(--bg); }
  </style>
</head>
<body>
  <header>
    <h1>Interactive Bible</h1>
    <button id="global-search-btn" title="Global Search">üîç</button>
  </header>

  <div class="controls">
    <select id="primary"></select>
    <div id="compare-container"></div>
    <select id="book"></select>
    <select id="chap"></select>
    <select id="verse"></select>
    <button id="prev">‚óÄ Prev</button>
    <button id="next">Next ‚ñ∂</button>
    <div class="range-wrapper">
      <input type="range" id="verse-slider">
    </div>
  </div>

  <main>
    <aside id="image-panel">
      <img id="verse-image" src="" alt="Verse Image">
    </aside>
    <div class="translations" id="output">
      <p style="color:var(--neutral)">Select a translation, book & chapter to begin...</p>
    </div>
  </main>

  <!-- Search Modal -->
  <div id="search-modal">
    <div class="search-overlay"></div>
    <div class="search-panel">
      <button id="search-close">‚úñ</button>
      <input id="search-input-global" placeholder="Search all verses‚Ä¶">
      <button id="start-search" disabled>Start Search</button>

      <div class="search-filters">
        <select id="filter-translation"><option value="">All Bibles</option></select>
        <select id="filter-testament">
          <option value="">Both</option>
          <option value="ot">Old Testament</option>
          <option value="nt">New Testament</option>
        </select>
        <select id="filter-book"><option value="">All Books</option></select>
        <select id="filter-chapter"><option value="">All Chapters</option></select>
      </div>
      <div class="search-stats" id="search-stats"></div>
      <ul id="search-results"></ul>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Helper to avoid null refs
      function fillSelect(sel, items) {
        if (!sel) return;
        sel.innerHTML = '';
        items.forEach(i => sel.append(new Option(i.label, i.value)));
        sel.disabled = !items.length;
      }

      // DOM refs
      const primary         = document.getElementById('primary'),
            compareC        = document.getElementById('compare-container'),
            bookSel         = document.getElementById('book'),
            chapSel         = document.getElementById('chap'),
            verseSel        = document.getElementById('verse'),
            prevBtn         = document.getElementById('prev'),
            nextBtn         = document.getElementById('next'),
            output          = document.getElementById('output'),
            verseImg        = document.getElementById('verse-image'),
            verseSlider     = document.getElementById('verse-slider'),
            globalSearchBtn = document.getElementById('global-search-btn'),
            searchModal     = document.getElementById('search-modal'),
            searchClose     = document.getElementById('search-close'),
            globalInput     = document.getElementById('search-input-global'),
            startBtn        = document.getElementById('start-search'),
            resultsList     = document.getElementById('search-results'),
            statsDiv        = document.getElementById('search-stats'),
            filtTrans       = document.getElementById('filter-translation'),
            filtTestament   = document.getElementById('filter-testament'),
            filtBook        = document.getElementById('filter-book'),
            filtChapter     = document.getElementById('filter-chapter');

      // Data holders
      const apiUrl = 'https://api.github.com/repos/mdudumi/thebim/contents/thebim/Translations';
      let transData = {}, lists = {}, state = { idx: 0, bkIdx: 0, chIdx: 0 };

      // Nest helper
      function nest(json) {
        const o = {};
        (json.verses||[]).forEach(v => {
          o[v.book_name] = o[v.book_name]||{};
          o[v.book_name][v.chapter] = o[v.book_name][v.chapter]||[];
          o[v.book_name][v.chapter].push(v.text);
        });
        return o;
      }

      // Fetch translation files
      const files = await fetch(apiUrl).then(r=>r.json()).catch(()=>[]);
      for (let f of files) {
        if (!f.name.endsWith('.json') || f.name.toLowerCase()==='index.json') continue;
        const name = f.name.replace(/\.json$/i, '');
        try {
          const data = await fetch(f.download_url).then(r=>r.json());
          transData[name] = nest(data);
          const books = Object.keys(transData[name]);
          const chs = {};
          books.forEach(b => chs[b] = Object.keys(transData[name][b]));
          lists[name] = { books, chapters: chs };
        } catch (e) { console.warn('Failed load', f.name); }
      }

      // Populate selects & compare checkboxes
      fillSelect(primary, Object.keys(transData).map(n=>({label:n,value:n})));
      Object.keys(transData).forEach(n => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${n}"> ${n}`;
        compareC.append(lbl);
      });
      fillSelect(filtTrans, Object.keys(transData).map(n=>({label:n,value:n})));

      // Event handlers...
      primary.onchange = () => {
        state = { idx:0, bkIdx:0, chIdx:0 };
        const books = lists[primary.value].books;
        fillSelect(bookSel, books.map((b,i)=>({label:b,value:i})));
        fillSelect(chapSel, []);
        fillSelect(verseSel, []);
        prevBtn.disabled = nextBtn.disabled = true;
        output.innerHTML = `<p style="color:var(--neutral);padding:1rem;">Select a book.</p>`;
        verseImg.src = '';
        verseSlider.disabled = true;
        updateURL();
      };
      bookSel.onchange = () => {
        state.bkIdx = +bookSel.value;
        const bk = lists[primary.value].books[state.bkIdx];
        const chs = lists[primary.value].chapters[bk];
        fillSelect(chapSel, chs.map((c,i)=>({label:c,value:i})));
        fillSelect(verseSel, []);
        prevBtn.disabled = nextBtn.disabled = true;
        output.innerHTML = `<p style="color:var(--neutral);padding:1rem;">Select a chapter.</p>`;
        verseImg.src = '';
        verseSlider.disabled = true;
        updateURL();
      };
      chapSel.onchange = () => {
        state.chIdx = +chapSel.value; state.idx = 0;
        const bk = lists[primary.value].books[state.bkIdx];
        const ch = lists[primary.value].chapters[bk][state.chIdx];
        const verses = transData[primary.value][bk][ch]||[];
        fillSelect(verseSel, verses.map((_,i)=>({label:i+1,value:i})));
        prevBtn.disabled = nextBtn.disabled = false;
        verseSlider.disabled = false;
        verseSlider.max = verses.length-1;
        verseSlider.value = 0;
        output.innerHTML = '';
        renderAll(); updateURL();
      };
      verseSel.onchange = () => {
        state.idx = +verseSel.value;
        verseSlider.value = state.idx;
        renderAll(); updateURL();
      };
      prevBtn.onclick = () => navigate(-1);
      nextBtn.onclick = () => navigate(1);
      verseSlider.oninput = () => {
        state.idx = +verseSlider.value;
        verseSel.value = state.idx;
        renderAll(); updateURL();
      };
      compareC.addEventListener('change', () => { if (!verseSel.disabled) renderAll(); });

      // Global search modal behavior
      globalSearchBtn.onclick = () => {
        searchModal.classList.add('active');
        globalInput.value = '';
        resultsList.innerHTML = '';
        statsDiv.textContent = '';
        filtTrans.focus();
      };
      searchClose.onclick = () => searchModal.classList.remove('active');

      startBtn.addEventListener('click', () => performSearch());
      globalInput.addEventListener('input', () => startBtn.disabled = !globalInput.value.trim());
      globalInput.addEventListener('keydown', e => { if (e.key==='Enter') performSearch(); });

      function performSearch() {
        const term = globalInput.value.trim().toLowerCase();
        if (!term) return;
        resultsList.innerHTML = '<li>Searching‚Ä¶</li>';
        statsDiv.textContent = '';
        const tf = filtTrans.value, tfm = filtTestament.value, bf = filtBook.value, cf = filtChapter.value;
        let matches = [];
        Object.entries(transData).forEach(([tn, bs]) => {
          if (tf && tn!==tf) return;
          lists[tn].books.forEach((bni, bii) => {
            if (bf!=='' && +bf!==bii) return;
            const isOT = bii<39;
            if (tfm==='ot'&&!isOT) return;
            if (tfm==='nt'&&isOT) return;
            const chs = bs[bni]||{};
            Object.entries(chs).forEach(([chn, vs], chi) => {
              if (cf!=='' && +cf!==chi) return;
              vs.forEach((txt, vi) => {
                if (txt.toLowerCase().includes(term)) {
                  const s = txt.toLowerCase().indexOf(term);
                  const sn = '‚Ä¶'+txt.substr(Math.max(0,s-20),term.length+40)+'‚Ä¶';
                  matches.push({tn,bii,chi,vi,sn});
                }
              });
            });
          });
        });
        statsDiv.textContent = `Found ${matches.length} occurrence${matches.length!==1?'s':''}`;
        resultsList.innerHTML = '';
        matches.forEach(m => {
          const bn = lists[m.tn].books[m.bii];
          const cn = lists[m.tn].chapters[bn][m.chi];
          const li = document.createElement('li');
          li.innerHTML = `<strong>[${m.tn}] ${bn} ${cn}:${m.vi+1}</strong><p><em>${m.sn}</em></p>`;
          li.onclick = () => {
            primary.value = m.tn; primary.onchange();
            bookSel.value = m.bii; bookSel.onchange();
            chapSel.value = m.chi; chapSel.onchange();
            verseSel.value = m.vi; verseSel.onchange();
            searchModal.classList.remove('active');
          };
          resultsList.append(li);
        });
      }

      // URL sync & rendering logic
      function updateURL(){
        const p = new URLSearchParams();
        p.set('primary', primary.value);
        p.set('book', state.bkIdx);
        p.set('chap', state.chIdx);
        p.set('verse', state.idx);
        history.replaceState(null,'','?'+p.toString());
        document.title = `${lists[primary.value].books[state.bkIdx]} ${state.chIdx+1}:${state.idx+1}`;
      }
      function renderAll(){
        output.innerHTML = '';
        const {idx,bkIdx,chIdx} = state;
        const main = primary.value;
        const bk = lists[main].books[bkIdx];
        const ch = lists[main].chapters[bk][chIdx];
        const vs = transData[main][bk][ch]||[];
        const total = vs.length;
        verseImg.src = `images/${bkIdx+1}/${chIdx+1}/${idx+1}.jpg`;
        const checked = Array.from(compareC.querySelectorAll('input:checked')).map(i=>i.value).filter(n=>n!==main);
        const names = [main, ...checked];
        names.forEach(name => {
          const b2 = lists[name].books[bkIdx];
          const c2s = lists[name].chapters[b2]||[];
          const txt = transData[name][b2]?.[c2s[chIdx]]?.[idx]||'';
          const card = document.createElement('div'); card.className = 'card';
          card.innerHTML = `<h2>${name}</h2><p>${txt}</p><div class="prog">${idx+1} / ${total}</div>`;
          const icons = document.createElement('div'); icons.className = 'icons';
          ['üìù','üìã','üîó'].forEach(sym => {
            const btn = document.createElement('button'); btn.innerText = sym;
            btn.onclick = () => {
              if (sym==='üìù') {
                const vid = `${name}|${bkIdx}|${chIdx}|${idx}`;
                const notes = JSON.parse(localStorage.getItem('notes')||'{}');
                const n = prompt('Note:', notes[vid]||'');
                notes[vid] = n; localStorage.setItem('notes', JSON.stringify(notes));
              }
              if (sym==='üìã') navigator.clipboard.writeText(txt).then(()=>alert('Copied!'));
              if (sym==='üîó') {
                const url = `${location.origin}${location.pathname}?primary=${name}&book=${bkIdx}&chap=${chIdx}&verse=${idx}`;
                if (navigator.share) navigator.share({title:`${bk} ${chIdx+1}:${idx+1}`,url});
                else navigator.clipboard.writeText(url).then(()=>alert('Link copied!'));
              }
            };
            icons.append(btn);
          });
          card.append(icons);
          output.append(card);
        });
        prevBtn.disabled = state.idx===0;
        nextBtn.disabled = state.idx>=total-1;
      }
      function navigate(d){
        const m = +verseSlider.max;
        state.idx = Math.max(0, Math.min(m, state.idx+d));
        verseSel.value = state.idx;
        verseSlider.value = state.idx;
        renderAll(); updateURL();
      }
      function handleDeepLink(){
        const p = new URLSearchParams(location.search);
        if (p.has('primary') && lists[p.get('primary')]) {
          primary.value = p.get('primary'); primary.onchange();
        }
        if (p.has('book')) { bookSel.value = p.get('book'); bookSel.onchange(); }
        if (p.has('chap')) { chapSel.value = p.get('chap'); chapSel.onchange(); }
        if (p.has('verse')) { verseSel.value = p.get('verse'); verseSel.onchange(); }
      }

      // Kick off
      primary.disabled = false;
      if (primary.options.length) {
        primary.selectedIndex = 0;
        primary.dispatchEvent(new Event('change'));
      }
      handleDeepLink();
    });
  </script>
</body>
</html>
